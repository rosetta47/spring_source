<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>static/index.html</title>
<link rel="stylesheet" href="/css/chat.css">
<script
   src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script
   src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script type="text/javascript">
   let stompClient = null;

   function connect() {
      let socket = new SockJS('/ws')// SockJS ìƒì„±ìë¡œ /wsë¥¼ ì¤˜.      /ws ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ WebSocket ì—°ê²° ê°ì²´ë¥¼ ìƒì„±

      // í´ë¼ì´ì–¸íŠ¸ê°€ WebSocket ì—°ê²°ì„ í†µí•´ì„œ Stomp(í´ë˜ìŠ¤)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
      stompClient = Stomp.over(socket);

      // ì—°ê²°ì— ì„±ê³µí•˜ë©´ ì½œë°± í•¨ìˆ˜ê°€ í˜¸ì¶œ
      stompClient.connect({}, function(frame) { // frame : command, header, body ë¡œ êµ¬ì„±
         console.log('connected : ' + frame);
         // '/topic/messages'ë¡œ ìˆ˜ì‹ ëœ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬
         // ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ (êµ¬ë…)í•  í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ê°€ í•´ë‹¹ ê²½ë¡œì— ë¸Œë¡œë“œìºìŠ¤íŠ¸í•œ ë©”ì„¸ì§€ë¥¼ ëª¨ë‘ ìˆ˜ì‹  ê°€ëŠ¥
         // íŠ¹ì • ì£¼ì œ('/topic/public')ë¥¼ êµ¬ë…í•˜ì—¬, ì„œë²„ì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ 
         stompClient.subscribe('/topic/public', function(message) {
            showMessage(message.body);
            //showMessage(JSON.parse(message.body));
         });
      })

   }

   function leaveChat() {
      if (stompClient) {
         stompClient.disconnect();
      }

      document.querySelector("#name").disabled = false;
      alert("Bye");
   }

   function sendMessage() { // ë©”ì„¸ì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
      let nameInput = document.querySelector("#name");
      let messageContent = document.querySelector("#message").value;

      // ì±„íŒ…ëª…(ì´ë¦„) ì…ë ¥ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš°, ì±„íŒ…ëª…ì„ ì…ë ¥ í›„ ì„œë²„ë¡œ ì „ì†¡ ==> ì´ë¦„ ì…ë ¥ë€ì„ ë¹„í™œì„±í™”
      if (!nameInput.disabled) { // disabledê°€ ì•„ë‹ˆë‹¤!
         stompClient.send("/app/chat.addUser", {}, JSON.stringify({
            sender : nameInput.value,
            type : 'JOIN'
         }));
         nameInput.disabled = true;
      }

      // ì…ë ¥ëœ ë©”ì‹œì§€ê°€ ìˆê³ , ì—°ê²°ì´ ëœ ìƒíƒœì¼ ë•Œ
      if (messageContent && stompClient) {
         let chatMessage = {
            sender : nameInput.value,
            content : messageContent,
            type : "CHAT"
         };

         stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
         document.querySelector("#message").value = "";
      }

      // send(ë©”ì„¸ì§€ëª©ì ì§€,ë©”ì„¸ì§€í—¤ë”,ë©”ì„¸ì§€ë‚´ìš©(payloadë¼ê³  í•¨)) - ì±„íŒ… ë©”ì„¸ì§€, ë°ì´í„° ê°±ì‹  ìš”ì²­, ì¢‹ì•„ìš” ìš”ì²­ ë“±ì„ ì„œë²„ë¡œ ì „ë‹¬í•˜ëŠ” ë° ì‚¬ìš©
      stompClient.send('/app/message', {}, messageContent);
   }
   
   function showMessage(message) {

       let messageData = JSON.parse(message);

       let messageElement = document.createElement("li");

       // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ì¶œë ¥ ë‚´ìš© ë‹¤ë¦„
       if (messageData.type === 'JOIN') {
           messageElement.classList.add('event-message');
           messageData.content = messageData.sender + " ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.";
       } else if (messageData.type === 'LEAVE') {
           messageElement.classList.add('event-message');
           messageData.content = messageData.sender + " ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.";
       } else {
           messageElement.classList.add('chat-message');

           let userNameElement = document.createElement('strong');
           userNameElement.classList.add('nickname');
           let usernameText = document.createTextNode(messageData.sender + " : ");
           userNameElement.appendChild(usernameText);
           messageElement.appendChild(userNameElement);
       }

       let textElement = document.createElement('span');
       let messageText = document.createTextNode(messageData.content);

       textElement.appendChild(messageText); // <span>ì±„íŒ… ë‚´ìš©</span>

       messageElement.appendChild(textElement);

       document.querySelector("#messageArea").appendChild(messageElement);

       // ìŠ¤í¬ë¡¤
       let messageArea = document.querySelector("#messageArea");
       messageArea.scrollTop = messageArea.scrollHeight;
   }

   window.onload = function() {
      connect();
   }

   window.onbeforeunload = function() {
      // ë¸Œë¼ìš°ì €ê°€ ë‹«íˆê¸° ì „ì— WebSocket ì—°ê²° ì¢…ë£Œ
      if (stompClient) {
         stompClient.disconnect();
      }
   }
</script>


</head>
<body>
   <div>
      <h2 style="color: #004d40">ğŸ¡ ì±„íŒ…</h2>
      <ul id="messageArea">
      </ul>

      <!-- ì…ë ¥ì°½ê³¼ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
      <div id="inputContainer">
         <input type="text" id="name" placeholder="ì´ë¦„ ì…ë ¥"> <input
            type="text" id="message" size="100" placeholder="ë©”ì„¸ì§€ ì…ë ¥"
            onkeydown="if (event.keyCode == 13) sendMessage()">
         <button onclick="sendMessage()">ì „ì†¡</button>
         <button onclick="leaveChat()">í‡´ì¥</button>
      </div>
   </div>
</body>

</html>